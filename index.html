<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carnet de Bord – Réservations libres</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2ecc71">

  <style>
    :root{
      --red:#e74c3c;
      --green:#2ecc71;
      --orange:#f39c12;
      --blue:#2980b9;
      --ink:#333;
      --muted:#777;
      --bg:#fafafa;
      --card:#fff;
      --violet:#483d8b;
      --orchid:mediumorchid;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1000px;margin:auto;padding:16px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    header .datebox{display:flex;gap:10px;align-items:center}
    input[type="date"]{font-size:18px;padding:8px 10px}
    h1{font-size:20px;margin:0;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #e6e6e6;border-radius:10px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card h2{margin:0 0 10px;font-size:18px}
    .row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    label.small{font-size:12px;color:var(--muted);display:block}
    input[type="time"],select,textarea,input[type="text"],input[type="email"]{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:8px;font-size:15px}

    .time-2{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:10px}
    .type-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .type-btn{border:none;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer}
    .type-EXP{color:var(--red);border:2px solid var(--red)}
    .type-LFT{color:var(--green);border:2px solid var(--green)}
    .type-PER{color:var(--orange);border:2px solid var(--orange)}
    .type-PAU{color:var(--blue);border:2px solid var(--blue)}
    .type-btn.active{color:#fff}
    .type-EXP.active{background:var(--red)}
    .type-LFT.active{background:var(--green)}
    .type-PER.active{background:var(--orange)}
    .type-PAU.active{background:var(--blue)}

    .pro-part{display:flex;flex-direction:column;gap:6px}
    .pp-btn{background:var(--orchid);color:#fff;border:none;border-radius:6px;padding:6px 10px;font-weight:bold;cursor:pointer}

    .inline-actions{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-block;border:1px solid #bbb;border-radius:999px;padding:4px 10px;font-size:12px;color:#444;background:#f5f5f5;cursor:pointer}
    .pill.orange{background:var(--orange);color:#fff;border-color:var(--orange)}
    .pill.violet{background:var(--violet);color:#fff;border-color:var(--violet)}

    .fieldset{border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:8px;background:#f9f9ff}
    .fieldset legend{font-weight:700}
    .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:680px){.cols-2{grid-template-columns:1fr}}

    .btn-primary{background:#222;color:#fff;border:none;border-radius:8px;padding:10px 14px;font-size:15px;cursor:pointer}
    .btn-secondary{background:#eee;color:#222;border:none;border-radius:8px;padding:10px 14px;font-size:15px;cursor:pointer}
    .btn-danger{background:#c44536;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}

    .res-item{border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;margin-bottom:10px;background:#fff;display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center}
    .badge{font-size:12px;font-weight:700;border-radius:6px;padding:3px 6px;display:inline-block}
    .bEXP{background:var(--red);color:#fff}
    .bLFT{background:var(--green);color:#fff}
    .bPER{background:var(--orange);color:#fff}
    .bPAU{background:var(--blue);color:#fff}
    .title-line{display:flex;flex-wrap:wrap;gap:8px;align-items:center}

    /* PRO / PART */
    .client-label{
      font-weight:bold;
      font-size:13px;
      color:#000;
    }

    /* Modifier / Supprimer */
    .actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .actions .btn-secondary,
    .actions .btn-danger{
      background:#fff;
      color:#000;
      border:1px solid #ccc;
      font-size:12px;
      padding:4px 8px;
      border-radius:4px;
      cursor:pointer;
      transition:background .2s;
    }
    .actions .btn-secondary:hover,
    .actions .btn-danger:hover{
      background:#f2f2f2;
    }

    /* Toast */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 16px;border-radius:6px;opacity:0;transition:opacity .4s,transform .4s;z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-10px)}

    @media(max-width:600px){
      .btn-primary,.btn-secondary,.btn-danger{width:100%;font-size:16px;padding:14px}
      textarea,input,select{font-size:16px}
      h1{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Agenda — réservations libres</h1>
      <div class="datebox"><label class="small">Date</label><input type="date" id="datePicker"/></div>
    </header>

    <div class="grid">
      <!-- Formulaire -->
      <section class="card">
        <h2>Nouvelle réservation</h2>
        <div class="row time-2">
          <div><label class="small">Début</label><input type="time" id="startTime" step="900"/></div>
          <div><label class="small">Fin</label><input type="time" id="endTime" step="900"/></div>
        </div>

        <div class="row">
          <label class="small">Type</label>
          <div class="type-buttons" id="typeButtons">
            <button class="type-btn type-EXP" data-type="EXP">LIFT EXPRESS</button>
            <button class="type-btn type-LFT" data-type="LFT"># LIFT</button>
            <button class="type-btn type-PER" data-type="PER">RDV PERSO</button>
            <button class="type-btn type-PAU" data-type="PAU">PAUSE</button>
          </div>
        </div>

        <div class="row">
          <div class="pro-part">
            <button class="pp-btn" id="btnPro">PRO</button>
            <button class="pp-btn" id="btnPart">PART</button>
          </div>

          <div style="flex:1">
            <div class="inline-actions">
              <span class="pill" id="btnNote">NOTE</span>
              <span class="pill" id="btnFacture">FACT</span>
              <span class="pill" id="btnAdresse">ADRESSE</span>
              <span class="pill" id="indVF">V(F)</span>
              <span class="pill" id="indVP">V(P)</span>
            </div>

            <div class="fieldset" id="noteBox" style="display:none"><legend>Note</legend><textarea id="note" rows="3"></textarea></div>
            <div class="fieldset" id="factureBox" style="display:none"><legend>Facture</legend><textarea id="facture" rows="3"></textarea></div>
            <div class="fieldset" id="adresseBox" style="display:none"><legend>Adresse</legend><textarea id="adresse" rows="2"></textarea></div>
          </div>
        </div>

        <div class="row">
          <button class="btn-primary" id="btnSave">Ajouter la réservation</button>
          <button class="btn-secondary" id="btnCancelEdit" style="display:none">Annuler modification</button>
        </div>
      </section>

      <!-- Liste -->
      <section class="card">
        <h2>Réservations du jour</h2>
        <div id="list"></div>
        <div id="empty" class="muted">Aucune réservation pour cette date.</div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAiRQYtjjPjkwiU76iqZGdnxgxjjbbaLQI",
      authDomain: "agendacarnet.firebaseapp.com",
      projectId: "agendacarnet",
      storageBucket: "agendacarnet.firebasestorage.app",
      messagingSenderId: "593717794727",
      appId: "1:593717794727:web:e45a8b06f4e9d356b74882"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = collection(db,"reservations_free");

    const $=(s)=>document.querySelector(s),$$=(s)=>document.querySelectorAll(s);
    const toHM=(t)=>t?.substring(0,5)||"";
    const colorFromType=(t)=>({EXP:"bEXP",LFT:"bLFT",PER:"bPER",PAU:"bPAU"}[t]||"");
    let selectedType="LFT",selectedClient="PRO",editingId=null;

    // Toast
    function showToast(msg,color="#333"){
      const t=document.createElement("div");
      t.className="toast";t.style.background=color;t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.classList.add("show"),50);
      setTimeout(()=>{t.classList.remove("show");setTimeout(()=>t.remove(),400);},3000);
    }

    // Notification système
    async function notify(title,body){
      if(Notification.permission==="granted"){new Notification(title,{body});}
      else if(Notification.permission!=="denied"){
        const perm=await Notification.requestPermission();
        if(perm==="granted") new Notification(title,{body});
      }
    }

    $("#datePicker").value=new Date().toISOString().split("T")[0];
    const typeButtons=$("#typeButtons");
    typeButtons.addEventListener("click",(e)=>{const b=e.target.closest(".type-btn");if(!b)return;selectedType=b.dataset.type;$$(".type-btn").forEach(x=>x.classList.remove("active"));b.classList.add("active");});
    typeButtons.querySelector('[data-type="LFT"]').classList.add("active");

    const btnPro=$("#btnPro"),btnPart=$("#btnPart");
    btnPro.addEventListener("click",()=>{selectedClient="PRO";btnPro.style.display="inline-block";btnPart.style.display="none";});
    btnPart.addEventListener("click",()=>{selectedClient="PART";btnPart.style.display="inline-block";btnPro.style.display="none";});

    // Note / Facture / Adresse toggles
    $("#btnNote").addEventListener("click",()=>toggleBox("noteBox","#btnNote"));
    $("#btnFacture").addEventListener("click",()=>toggleBox("factureBox","#btnFacture"));
    $("#btnAdresse").addEventListener("click",()=>toggleBox("adresseBox","#btnAdresse"));
    $("#indVF").addEventListener("click",()=>$("#indVF").classList.toggle("violet"));
    $("#indVP").addEventListener("click",()=>$("#indVP").classList.toggle("violet"));

    function toggleBox(id,pillSel){
      const el=$("#"+id); const pill=$(pillSel);
      const show = el.style.display==="none"||el.style.display==="";
      el.style.display=show?"block":"none";
      if(id==="noteBox"||id==="factureBox"){
        const txt = id==="noteBox" ? $("#note").value.trim() : $("#facture").value.trim();
        pill.classList.toggle("orange",txt.length>0);
      }
    }

    // coloration bouton quand on tape dans Note/Facture
    $("#note").addEventListener("input",()=>$("#btnNote").classList.toggle("orange",$("#note").value.trim().length>0));
    $("#facture").addEventListener("input",()=>$("#btnFacture").classList.toggle("orange",$("#facture").value.trim().length>0));

    async function refreshList(){
      const d=$("#datePicker").value;
      $("#list").innerHTML="";$("#empty").style.display="block";
      const q=query(COL,where("date","==",d),orderBy("start"));
      const snap=await getDocs(q);
      let count=0;
      snap.forEach(docSnap=>{
        count++;
        $("#list").appendChild(renderItem(docSnap.id,docSnap.data()));
      });
      $("#empty").style.display=count?"none":"block";
    }

    function renderItem(id,data){
      const div=document.createElement("div");
      div.className="res-item";
      const badgeClass=colorFromType(data.type);
      div.innerHTML=`
        <div>
          <div class="title-line">
            <span class="badge ${badgeClass}">${data.type}</span>
            <strong>${toHM(data.start)} → ${toHM(data.end)}</strong>
            <span class="client-label">${data.client}</span>
            ${data.vf?`<span class="pill violet">V(F)</span>`:""}
            ${data.vp?`<span class="pill violet">V(P)</span>`:""}
            ${data.note?`<span class="pill orange">NOTE</span>`:""}
            ${data.facture?`<span class="pill orange">FACT</span>`:""}
          </div>
          ${data.adresse?`<div><strong>${data.adresse}</strong></div>`:""}
        </div>
        <div class="actions">
          <button class="btn-secondary" data-act="edit">Modifier</button>
          <button class="btn-danger" data-act="del">Annuler</button>
        </div>`;
      div.querySelector('[data-act="del"]').addEventListener("click",async()=>{if(confirm("Supprimer ?")){await deleteDoc(doc(db,"reservations_free",id));showToast("Réservation supprimée ❌","#c44536");refreshList();}});
      div.querySelector('[data-act="edit"]').addEventListener("click",()=>loadIntoForm(id,data));
      return div;
    }

    $("#btnSave").addEventListener("click",saveReservation);
    $("#btnCancelEdit").addEventListener("click",()=>{editingId=null;clearForm();});

    async function saveReservation(){
      const date=$("#datePicker").value,start=$("#startTime").value,end=$("#endTime").value;
      if(!start||!end||end<=start){alert("Heures invalides");return;}
      const note=$("#note").value.trim();
      const facture=$("#facture").value.trim();
      const adresse=$("#adresse").value.trim().toUpperCase();
      const vf=$("#indVF").classList.contains("violet");
      const vp=$("#indVP").classList.contains("violet");
      const data={date,start,end,type:selectedType,client:selectedClient,note,facture,adresse,vf,vp,createdAt:Date.now()};
      if(editingId){await updateDoc(doc(db,"reservations_free",editingId),data);showToast("Réservation modifiée ✏️","#f39c12");notify("Réservation modifiée","Un créneau a été modifié.");}
      else{await addDoc(COL,data);showToast("Réservation ajoutée ✅","#2ecc71");notify("Nouvelle réservation","Un créneau a été ajouté.");}
      editingId=null;clearForm();refreshList();
    }

    function loadIntoForm(id,d){editingId=id;
      $("#datePicker").value=d.date;$("#startTime").value=d.start;$("#endTime").value=d.end;
      selectedType=d.type;$$(".type-btn").forEach(x=>x.classList.toggle("active",x.dataset.type===selectedType));
      if(d.client==="PRO")btnPro.click();else btnPart.click();
      $("#note").value=d.note||"";$("#facture").value=d.facture||"";$("#adresse").value=d.adresse||"";
      $("#btnNote").classList.toggle("orange",!!d.note);$("#btnFacture").classList.toggle("orange",!!d.facture);
      $("#indVF").classList.toggle("violet",!!d.vf);$("#indVP").classList.toggle("violet",!!d.vp);
    }

    function clearForm(){
      $("#startTime").value="";$("#endTime").value="";
      $("#note").value="";$("#facture").value="";$("#adresse").value="";
      $("#btnNote").classList.remove("orange");$("#btnFacture").classList.remove("orange");
      selectedType="LFT";$$(".type-btn").forEach(x=>x.classList.remove("active"));typeButtons.querySelector('[data-type="LFT"]').classList.add("active");
      btnPro.style.display="inline-block";btnPart.style.display="inline-block";selectedClient="PRO";
      $("#indVF").classList.remove("violet");$("#indVP").classList.remove("violet");
      $("#noteBox").style.display="none";$("#adresseBox").style.display="none";$("#factureBox").style.display="none";
    }

    $("#datePicker").addEventListener("change",refreshList);
    refreshList();
  </script>
</body>
</html>


