<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carnet de Bord – Réservations libres</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2ecc71">
  <style>
    :root{
      --red:#e74c3c;
      --green:#2ecc71;
      --orange:#f39c12;
      --blue:#2980b9;
      --ink:#333;
      --muted:#777;
      --bg:#fafafa;
      --card:#fff;
      --violet:#483d8b;
      --orchid:mediumorchid;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1000px;margin:auto;padding:16px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    header .datebox{display:flex;gap:10px;align-items:center}
    input[type="date"]{font-size:18px;padding:8px 10px}
    h1{font-size:20px;margin:0;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #e6e6e6;border-radius:10px;padding:14px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .card h2{margin:0 0 10px;font-size:18px}

    .row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    label.small{font-size:12px;color:var(--muted);display:block}
    input[type="time"],select,textarea,input[type="text"],input[type="email"]{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:8px;font-size:15px}

    .time-2{display:grid;grid-template-columns:repeat(2,minmax(140px,1fr));gap:10px}

    /* Types */
    .type-buttons{display:flex;flex-wrap:wrap;gap:8px}
    .type-btn{border:none;border-radius:999px;padding:6px 10px;font-weight:700;cursor:pointer;background:#fff}
    .type-EXP{color:var(--red);border:2px solid var(--red)}
    .type-LFT{color:var(--green);border:2px solid var(--green)}
    .type-PER{color:var(--orange);border:2px solid var(--orange)}
    .type-PAU{color:var(--blue);border:2px solid var(--blue)}
    .type-btn.active{color:#fff}
    .type-EXP.active{background:var(--red)}
    .type-LFT.active{background:var(--green)}
    .type-PER.active{background:var(--orange)}
    .type-PAU.active{background:var(--blue)}

    /* PRO / PART */
    .pro-part{display:flex;flex-direction:column;gap:6px}
    .pp-btn{background:#eee;color:#111;border:1px solid #ccc;border-radius:6px;padding:6px 10px;font-weight:bold;cursor:pointer}
    .pp-btn.active{border-color:var(--violet);color:var(--violet);background:#f4f0ff}

    .inline-actions{display:flex;flex-wrap:wrap;gap:8px}
    .pill{display:inline-block;border:1px solid #bbb;border-radius:999px;padding:4px 10px;font-size:12px;color:#444;background:#f5f5f5;cursor:pointer}
    .pill.orange{background:var(--orange);color:#fff;border-color:var(--orange)}
    .pill.violet{background:var(--violet);color:#fff;border-color:var(--violet)}

    .fieldset{border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:8px;background:#f9f9ff}
    .fieldset legend{font-weight:700}
    .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media(max-width:680px){.cols-2{grid-template-columns:1fr}}

    .btn-primary{background:#222;color:#fff;border:none;border-radius:8px;padding:10px 14px;font-size:15px;cursor:pointer}
    .btn-secondary{background:#fff;color:#000;border:1px solid #ccc;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
    .btn-danger{background:#fff;color:#000;border:1px solid #ccc;border-radius:4px;padding:4px 8px;font-size:12px;cursor:pointer}
    .btn-secondary:hover,.btn-danger:hover{background:#f2f2f2}

    /* Liste */
    .res-item{border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;margin-bottom:10px;background:#fff}
    .title-line{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .left-part{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .right-part{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .badge{font-size:12px;font-weight:700;border-radius:6px;padding:3px 6px;display:inline-block}
    .bEXP{background:var(--red);color:#fff}
    .bLFT{background:var(--green);color:#fff}
    .bPER{background:var(--orange);color:#fff}
    .bPAU{background:var(--blue);color:#fff}

    .client-label{font-weight:700;color:var(--violet)} /* PRO / PART mauve */
    .muted{color:var(--muted);font-size:12px}

    .res-actions{display:flex;justify-content:center;gap:8px;margin-top:6px}

    /* Toast */
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 16px;border-radius:6px;opacity:0;transition:opacity .4s,transform .4s;z-index:9999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-10px)}

    @media(max-width:600px){
      .btn-primary{width:100%;font-size:16px;padding:14px}
      textarea,input,select{font-size:16px}
      h1{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Agenda — réservations libres</h1>
      <div class="datebox"><label class="small">Date</label><input type="date" id="datePicker"/></div>
    </header>

    <div class="grid">
      <!-- Formulaire -->
      <section class="card">
        <h2>Nouvelle réservation</h2>

        <div class="row time-2">
          <div><label class="small">Début</label><input type="time" id="startTime" step="900"/></div>
          <div><label class="small">Fin</label><input type="time" id="endTime" step="900"/></div>
        </div>

        <div class="row">
          <label class="small">Type</label>
          <div class="type-buttons" id="typeButtons">
            <button class="type-btn type-EXP" data-type="EXP">LIFT EXPRESS</button>
            <button class="type-btn type-LFT" data-type="LFT"># LIFT</button>
            <button class="type-btn type-PER" data-type="PER">RDV PERSO</button>
            <button class="type-btn type-PAU" data-type="PAU">PAUSE</button>
          </div>
        </div>

        <div class="row">
          <div class="pro-part">
            <button class="pp-btn active" id="btnPro">PRO</button>
            <button class="pp-btn" id="btnPart">PART</button>
          </div>

          <div style="flex:1">
            <div class="inline-actions">
              <span class="pill" id="btnNote">NOTE</span>
              <span class="pill" id="btnFacture">FACTURE</span>
              <span class="pill" id="btnAdresse">ADRESSE</span>
              <span class="pill" id="indVF">V(F)</span>
              <span class="pill" id="indVP">V(P)</span>
            </div>

            <!-- NOTE -->
            <div class="fieldset" id="noteBox" style="display:none">
              <legend>Note</legend>
              <textarea id="note" rows="3" placeholder="Votre note…"></textarea>
            </div>

            <!-- FACTURE (corrigée / complète) -->
            <div class="fieldset" id="factureBox" style="display:none">
              <legend>Facturation</legend>

              <div class="row cols-2">
                <div>
                  <label class="small">Type de client</label>
                  <select id="factType">
                    <option value="PRO">PRO</option>
                    <option value="PART">PARTICULIER</option>
                  </select>
                </div>
                <div>
                  <label class="small">Statut client</label>
                  <select id="factStatus">
                    <option value="encore">Pas encodé</option>
                    <option value="deja">Déjà encodé</option>
                  </select>
                </div>
              </div>

              <!-- Bloc PRO -->
              <div id="blocPro" class="row">
                <div style="flex:1">
                  <label class="small">Nom de la firme (obligatoire)</label>
                  <input type="text" id="proFirme"/>
                </div>
              </div>
              <div id="extraPro" class="row cols-2">
                <input type="text" id="proRue" placeholder="Rue et n°"/>
                <input type="text" id="proCP" placeholder="Code postal"/>
                <input type="text" id="proVille" placeholder="Ville"/>
                <input type="text" id="proTVA" placeholder="N° TVA"/>
                <input type="email" id="proEmail" placeholder="Email"/>
              </div>

              <!-- Bloc PART -->
              <div id="blocPart" class="row" style="display:none">
                <div class="cols-2" style="flex:1">
                  <div>
                    <label class="small">Prénom (obligatoire)</label>
                    <input type="text" id="partPrenom"/>
                  </div>
                  <div>
                    <label class="small">Nom (obligatoire)</label>
                    <input type="text" id="partNom"/>
                  </div>
                </div>
              </div>
              <div id="extraPart" class="row cols-2" style="display:none">
                <input type="text" id="partRue" placeholder="Rue et n°"/>
                <input type="text" id="partCP" placeholder="Code postal"/>
                <input type="text" id="partVille" placeholder="Ville"/>
                <input type="email" id="partEmail" placeholder="Email"/>
              </div>

              <div class="row">
                <div style="flex:1">
                  <label class="small">Mode de paiement (obligatoire)</label>
                  <select id="factPay">
                    <option value="">-- Choisir --</option>
                    <option value="cash">Payé cash</option>
                    <option value="virement">Payé virement</option>
                    <option value="non">Non payé</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- ADRESSE -->
            <div class="fieldset" id="adresseBox" style="display:none">
              <legend>Adresse</legend>
              <textarea id="adresse" rows="2" placeholder="Adresse (affichée en MAJUSCULES dans la liste)"></textarea>
            </div>
          </div>
        </div>

        <div class="row">
          <button class="btn-primary" id="btnSave">Ajouter la réservation</button>
          <button class="btn-secondary" id="btnCancelEdit" style="display:none">Annuler modification</button>
        </div>
      </section>

      <!-- Liste -->
      <section class="card">
        <h2>Réservations du jour</h2>
        <div id="list"></div>
        <div id="empty" class="muted">Aucune réservation pour cette date.</div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // === CONFIG FIREBASE (ta config) ===
    const firebaseConfig = {
      apiKey: "AIzaSyAiRQYtjjPjkwiU76iqZGdnxgxjjbbaLQI",
      authDomain: "agendacarnet.firebaseapp.com",
      projectId: "agendacarnet",
      storageBucket: "agendacarnet.firebasestorage.app",
      messagingSenderId: "593717794727",
      appId: "1:593717794727:web:e45a8b06f4e9d356b74882"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const COL = collection(db,"reservations_free");

    // === UTIL ===
    const $=(s)=>document.querySelector(s), $$=(s)=>document.querySelectorAll(s);
    const toHM=(t)=>t?.substring(0,5)||"";
    const colorFromType=(t)=>({EXP:"bEXP",LFT:"bLFT",PER:"bPER",PAU:"bPAU"}[t]||"");

    // === ÉTAT ===
    let selectedType="LFT";
    let selectedClient="PRO";
    let editingId=null;

    // === TOAST + NOTIF ===
    function showToast(msg,color="#333"){
      const t=document.createElement("div");
      t.className="toast"; t.style.background=color; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.classList.add("show"),50);
      setTimeout(()=>{t.classList.remove("show"); setTimeout(()=>t.remove(),400);},3000);
    }
    async function notify(title,body){
      try{
        if(Notification.permission==="granted"){ new Notification(title,{body}); }
        else if(Notification.permission!=="denied"){
          const perm=await Notification.requestPermission();
          if(perm==="granted") new Notification(title,{body});
        }
      }catch(e){}
    }

    // === INIT UI ===
    $("#datePicker").value=new Date().toISOString().split("T")[0];

    // Types
    const typeButtons=$("#typeButtons");
    typeButtons.addEventListener("click",(e)=>{
      const b=e.target.closest(".type-btn"); if(!b) return;
      selectedType=b.dataset.type;
      $$(".type-btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
    });
    typeButtons.querySelector('[data-type="LFT"]').classList.add("active");

    // PRO/PART
    const btnPro=$("#btnPro"), btnPart=$("#btnPart");
    function setClient(c){
      selectedClient=c;
      btnPro.classList.toggle("active", c==="PRO");
      btnPart.classList.toggle("active", c==="PART");
    }
    btnPro.addEventListener("click",()=>setClient("PRO"));
    btnPart.addEventListener("click",()=>setClient("PART"));

    // Toggle zones
    $("#btnNote").addEventListener("click",()=>toggleBox("noteBox","#btnNote"));
    $("#btnFacture").addEventListener("click",()=>toggleBox("factureBox","#btnFacture"));
    $("#btnAdresse").addEventListener("click",()=>toggleBox("adresseBox","#btnAdresse"));
    $("#indVF").addEventListener("click",()=>$("#indVF").classList.toggle("violet"));
    $("#indVP").addEventListener("click",()=>$("#indVP").classList.toggle("violet"));

    function toggleBox(id, pillSel){
      const el = $("#"+id);
      const pill = $(pillSel);
      const show = (el.style.display==="none"||el.style.display==="");
      el.style.display = show ? "block" : "none";
      // mettre la teinte orange si contenu présent
      if(id==="noteBox") pill.classList.toggle("orange", $("#note").value.trim().length>0);
      if(id==="factureBox") pill.classList.toggle("orange", factureIsValid());
    }

    // Facture : logique d'affichage et indicateur
    $("#factType").addEventListener("change", updateFactureUI);
    $("#factStatus").addEventListener("change", updateFactureUI);
    ["proFirme","factPay","partPrenom","partNom","proRue","proCP","proVille","proTVA","proEmail","partRue","partCP","partVille","partEmail"].forEach(id=>{
      const el=$("#"+id); if(!el) return;
      el.addEventListener("input", ()=> $("#btnFacture").classList.toggle("orange", factureIsValid()));
      if(el.tagName==="SELECT") el.addEventListener("change", ()=> $("#btnFacture").classList.toggle("orange", factureIsValid()));
    });

    function updateFactureUI(){
      const type=$("#factType").value;
      const status=$("#factStatus").value; // deja / encore
      $("#blocPro").style.display  = (type==="PRO")? "block":"none";
      $("#blocPart").style.display = (type==="PART")? "block":"none";
      $("#extraPro").style.display  = (type==="PRO"  && status==="encore")? "grid":"none";
      $("#extraPart").style.display = (type==="PART" && status==="encore")? "grid":"none";
      $("#btnFacture").classList.toggle("orange", factureIsValid());
    }
    function factureIsValid(){
      // critères minimaux pour allumer le voyant FACT
      const type=$("#factType").value, pay=$("#factPay").value;
      if(type==="PRO"){
        return ($("#proFirme").value.trim().length>0) && (pay!=="");
      }else{
        return ($("#partPrenom").value.trim().length>0) && ($("#partNom").value.trim().length>0) && (pay!=="");
      }
    }

    // coloration NOTE
    $("#note").addEventListener("input",()=> $("#btnNote").classList.toggle("orange", $("#note").value.trim().length>0));

    // === LISTE ===
    $("#datePicker").addEventListener("change", refreshList);
    async function refreshList(){
      const d=$("#datePicker").value;
      $("#list").innerHTML=""; $("#empty").style.display="block";
      const q = query(COL, where("date","==",d), orderBy("start"));
      const snap = await getDocs(q);
      let count=0;
      snap.forEach(docSnap=>{
        count++;
        $("#list").appendChild(renderItem(docSnap.id, docSnap.data()));
      });
      $("#empty").style.display = count? "none":"block";
    }

    function renderItem(id, data){
      const div = document.createElement("div");
      div.className = "res-item";
      const badgeClass = colorFromType(data.type);
      const pills=[];
      if(data.vf) pills.push(`<span class="pill violet">V(F)</span>`);
      if(data.vp) pills.push(`<span class="pill violet">V(P)</span>`);
      if((data.note||"").trim().length>0) pills.push(`<span class="pill orange">NOTE</span>`);
      if(data.fact) pills.push(`<span class="pill orange">FACT</span>`); // pas d'affichage des détails facture

      const adresseHTML = (data.adresse||"").trim().length? `<div><strong>${(data.adresse||"")}</strong></div>` : "";

      div.innerHTML = `
        <div class="title-line">
          <div class="left-part">
            <span class="badge ${badgeClass}">${data.type}</span>
            <strong>${toHM(data.start)} → ${toHM(data.end)}</strong>
            <span class="client-label">${data.client}</span>
          </div>
          <div class="right-part">${pills.join(" ")}</div>
        </div>
        ${adresseHTML}
        <div class="res-actions">
          <button class="btn-secondary" data-act="edit">Modifier</button>
          <button class="btn-danger" data-act="del">Annuler</button>
        </div>
      `;

      div.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
        if(confirm("Supprimer cette réservation ?")){
          await deleteDoc(doc(db,"reservations_free", id));
          showToast("Réservation supprimée ❌","#c44536");
          refreshList();
        }
      });
      div.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        loadIntoForm(id, data);
      });
      return div;
    }

    // === SAISIE / ENREGISTREMENT ===
    $("#btnSave").addEventListener("click", saveReservation);
    $("#btnCancelEdit").addEventListener("click", ()=>{
      editingId=null; clearForm(); updateSaveBtn();
    });

    function updateSaveBtn(){
      $("#btnSave").textContent = editingId? "Enregistrer les modifications" : "Ajouter la réservation";
      $("#btnCancelEdit").style.display = editingId? "inline-block" : "none";
    }

    function collectFacture(){
      // Si le bloc facture est fermé ET que l'indicateur n'est pas orange -> pas de facture
      const boxVisible = $("#factureBox").style.display!=="none" && $("#factureBox").style.display!=="";
      if(!boxVisible && !$("#btnFacture").classList.contains("orange")) return null;

      const type=$("#factType").value, status=$("#factStatus").value, pay=$("#factPay").value;
      const base = { type, status, pay };

      if(type==="PRO"){
        base.pro = {
          firme: $("#proFirme").value.trim(),
          rue:   $("#proRue").value.trim(),
          cp:    $("#proCP").value.trim(),
          ville: $("#proVille").value.trim(),
          tva:   $("#proTVA").value.trim(),
          email: $("#proEmail").value.trim(),
        };
      }else{
        base.part = {
          prenom: $("#partPrenom").value.trim(),
          nom:    $("#partNom").value.trim(),
          rue:    $("#partRue").value.trim(),
          cp:     $("#partCP").value.trim(),
          ville:  $("#partVille").value.trim(),
          email:  $("#partEmail").value.trim(),
        };
      }
      // si rien d'utile -> null
      const hasMinimum = factureIsValid();
      return hasMinimum ? base : null;
    }

    function validateFactureForSave(fact, client){
      if(!fact) return true;              // pas de facture -> ok
      if(fact.type!==client) return false;// type doit coller au client
      if(!fact.pay) return false;
      if(client==="PRO"){
        return !!(fact.pro?.firme);
      }else{
        return !!(fact.part?.prenom) && !!(fact.part?.nom);
      }
    }

    async function saveReservation(){
      const date=$("#datePicker").value;
      const start=$("#startTime").value;
      const end  =$("#endTime").value;
      if(!start || !end || end<=start){ alert("Heures invalides"); return; }

      const note = $("#note").value.trim();
      const adresse = $("#adresse").value.trim().toUpperCase();
      const vf = $("#indVF").classList.contains("violet");
      const vp = $("#indVP").classList.contains("violet");
      const fact = collectFacture();
      const client = selectedClient;

      if(!validateFactureForSave(fact, client)){
        alert("Facture incomplète selon le type choisi.");
        return;
      }

      const data = {
        date, start, end,
        type: selectedType,
        client,
        note,
        adresse,
        vf, vp,
        fact,              // null ou objet
        createdAt: Date.now()
      };

      if(editingId){
        await updateDoc(doc(db,"reservations_free", editingId), data);
        showToast("Réservation modifiée ✏️","#f39c12"); notify("Réservation modifiée","Un créneau a été modifié.");
      }else{
        await addDoc(COL, data);
        showToast("Réservation ajoutée ✅","#2ecc71"); notify("Nouvelle réservation","Un créneau a été ajouté.");
      }
      editingId=null; updateSaveBtn();
      clearForm();
      refreshList();
    }

    function loadIntoForm(id, d){
      editingId=id; updateSaveBtn();

      // Réinitialiser PRO/PART visibles, puis appliquer la sélection
      btnPro.style.display="inline-block"; btnPart.style.display="inline-block";
      setClient(d.client==="PART"?"PART":"PRO");

      $("#datePicker").value = d.date;
      $("#startTime").value  = d.start;
      $("#endTime").value    = d.end;

      selectedType = d.type;
      $$(".type-btn").forEach(x=>x.classList.toggle("active", x.dataset.type===selectedType));

      $("#note").value = d.note || "";
      $("#btnNote").classList.toggle("orange", (d.note||"").trim().length>0);

      $("#adresse").value = d.adresse || "";
      $("#indVF").classList.toggle("violet", !!d.vf);
      $("#indVP").classList.toggle("violet", !!d.vp);

      if(d.fact){
        $("#factureBox").style.display="block";
        $("#btnFacture").classList.add("orange");

        $("#factType").value = d.fact.type || d.client;
        $("#factStatus").value = d.fact.status || "encore";
        $("#factPay").value = d.fact.pay || "";

        updateFactureUI();

        if(d.fact.type==="PRO"){
          $("#proFirme").value = d.fact.pro?.firme || "";
          $("#proRue").value   = d.fact.pro?.rue   || "";
          $("#proCP").value    = d.fact.pro?.cp    || "";
          $("#proVille").value = d.fact.pro?.ville || "";
          $("#proTVA").value   = d.fact.pro?.tva   || "";
          $("#proEmail").value = d.fact.pro?.email || "";
        }else{
          $("#partPrenom").value = d.fact.part?.prenom || "";
          $("#partNom").value    = d.fact.part?.nom    || "";
          $("#partRue").value    = d.fact.part?.rue    || "";
          $("#partCP").value     = d.fact.part?.cp     || "";
          $("#partVille").value  = d.fact.part?.ville  || "";
          $("#partEmail").value  = d.fact.part?.email  || "";
        }
      }else{
        $("#factureBox").style.display="none";
        $("#btnFacture").classList.remove("orange");
        resetFactureFields();
      }
      updateFactureUI();
    }

    function resetFactureFields(){
      $("#factType").value="PRO";
      $("#factStatus").value="encore";
      $("#factPay").value="";
      ["proFirme","proRue","proCP","proVille","proTVA","proEmail","partPrenom","partNom","partRue","partCP","partVille","partEmail"].forEach(id=>{
        const el=$("#"+id); if(el) el.value="";
      });
      $("#btnFacture").classList.remove("orange");
    }

    function clearForm(){
      $("#startTime").value=""; $("#endTime").value="";
      selectedType="LFT";
      $$(".type-btn").forEach(x=>x.classList.remove("active"));
      typeButtons.querySelector('[data-type="LFT"]').classList.add("active");

      // PRO par défaut, mais garder les deux visibles
      setClient("PRO");
      btnPro.style.display="inline-block"; btnPart.style.display="inline-block";

      $("#note").value=""; $("#btnNote").classList.remove("orange");
      $("#adresse").value="";
      $("#indVF").classList.remove("violet"); $("#indVP").classList.remove("violet");

      $("#factureBox").style.display="none";
      resetFactureFields();

      $("#noteBox").style.display="none";
      $("#adresseBox").style.display="none";
    }

    // PREMIER RENDU
    refreshList();
  </script>
</body>
</html>



