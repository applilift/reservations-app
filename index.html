<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agenda Lift</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f5132">
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f5f5f5;
    }
    header {
      background: #0f5132;
      color: white;
      padding: 1rem;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 1rem;
    }
    .badge {
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.8rem;
    }
    .badge-green { background: #2ecc71; color: white; }
    .badge-blue { background: #3498db; color: white; }
    .pill {
      display: inline-block;
      padding: 0.2rem 0.4rem;
      border-radius: 0.4rem;
      font-size: 0.75rem;
      margin-left: 0.3rem;
    }
    .pill.orange { background: orange; color: white; }
    .pill.violet { background: rebeccapurple; color: white; }
    .client-pro { font-weight: bold; color: #2ecc71; margin-left: 0.5rem; }
    .client-part { font-weight: bold; color: #3498db; margin-left: 0.5rem; }
    .reservation-item {
      background: white;
      margin: 0.5rem 0;
      padding: 0.5rem;
      border-radius: 0.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .title-line {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .facture {
      color: orange;
      margin-top: 4px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  <h1>Agenda des réservations</h1>
</header>

<div class="container">

  <!-- Nouvelle réservation -->
  <section id="new-reservation">
    <h2>Nouvelle réservation</h2>
    <form id="reservation-form">
      <div>
        <label>Nom : <input type="text" id="nom"></label>
      </div>
      <div>
        <label>Adresse : <input type="text" id="adresse"></label>
      </div>
      <div>
        <label>Type :
          <select id="type">
            <option value="Intervention">Intervention</option>
            <option value="Autre">Autre</option>
          </select>
        </label>
      </div>
      <div>
        <label>Client :
          <select id="client">
            <option value="PRO">PRO</option>
            <option value="PART">PART</option>
          </select>
        </label>
      </div>
      <div>
        <label>Heure début : <input type="datetime-local" id="start"></label>
      </div>
      <div>
        <label>Heure fin : <input type="datetime-local" id="end"></label>
      </div>
      <div>
        <label>Facture : <input type="text" id="facture"></label>
      </div>
      <button type="submit">Enregistrer</button>
    </form>
  </section>

  <!-- Réservations du jour -->
  <section id="today-reservations">
    <h2>Réservations du jour</h2>
    <div id="reservations-list"></div>
  </section>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

const firebaseConfig = {
  // Ta config Firebase ici
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function toHM(date) {
  const d = new Date(date);
  return d.toLocaleTimeString("fr-FR", {hour:"2-digit", minute:"2-digit"});
}

function escapeHTML(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
// Envoi du formulaire vers Firestore
const form = document.getElementById("reservation-form");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nom = document.getElementById("nom").value.trim();
  const adresse = document.getElementById("adresse").value.trim();
  const type = document.getElementById("type").value;
  const client = document.getElementById("client").value;
  const start = document.getElementById("start").value;
  const end = document.getElementById("end").value;
  const facture = document.getElementById("facture").value.trim();

  if (!nom || !start || !end) {
    alert("Merci de remplir au moins le nom et les heures.");
    return;
  }

  const factData = facture
    ? {
        type: client,
        pro: client === "PRO" ? { firme: facture } : null,
        part: client === "PART" ? { nom: facture } : null,
        pay: "À définir"
      }
    : null;

  await addDoc(collection(db, "reservations"), {
    nom,
    adresse,
    type,
    client,
    start: new Date(start).toISOString(),
    end: new Date(end).toISOString(),
    fact: factData
  });

  form.reset();
  resetProPartButtons();
  loadReservations();
});

// ✅ Fonction d'affichage d'un item de réservation avec facture
function renderItem(id, data) {
  const badgeClass = data.type === "Intervention" ? "badge-green" : "badge-blue";
  const clientClass = data.client === "PRO" ? "client-pro" : "client-part";

  let html = `
    <div class="reservation-item" data-id="${id}">
      <div class="title-line">
        <span class="badge ${badgeClass}">${escapeHTML(data.type || "")}</span>
        <strong>${toHM(data.start)} → ${toHM(data.end)}</strong>
        <span class="${clientClass}">${escapeHTML(data.client || "")}</span>
        ${data.vf ? `<span class="pill violet">V(F)</span>` : ""}
        ${data.vp ? `<span class="pill violet">V(P)</span>` : ""}
        ${data.note ? `<span class="pill orange">Note</span>` : ""}
        ${data.fact ? `<span class="pill orange">Facture</span>` : ""}
      </div>
      ${data.adresse ? `<div><strong>${escapeHTML(data.adresse.toString())}</strong></div>` : ""}
      ${data.fact ? `
        <div class="facture">
          ${
            data.fact.type === "PRO"
              ? `${escapeHTML(data.fact.pro?.firme || "")}`
              : `${escapeHTML(data.fact.part?.nom || "")}`
          }
          ${data.fact.pay ? ` | Paiement : ${escapeHTML(data.fact.pay)}` : ""}
        </div>
      ` : ""}
      <div class="actions">
        <button class="btn-modifier" data-id="${id}">Modifier</button>
      </div>
    </div>
  `;
  return html;
}

// Chargement des réservations du jour
async function loadReservations() {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const tomorrow = new Date(today);
  tomorrow.setDate(today.getDate() + 1);

  const snap = await getDocs(collection(db, "reservations"));
  const list = document.getElementById("reservations-list");
  list.innerHTML = "";

  snap.forEach(docSnap => {
    const data = docSnap.data();
    const start = new Date(data.start);
    if (start >= today && start < tomorrow) {
      list.innerHTML += renderItem(docSnap.id, data);
    }
  });
}

// ✅ Logique PRO / PART
const clientSelect = document.getElementById("client");
const proBtn = document.createElement("button");
proBtn.textContent = "PRO";
proBtn.type = "button";
const partBtn = document.createElement("button");
partBtn.textContent = "PART";
partBtn.type = "button";
clientSelect.insertAdjacentElement("afterend", partBtn);
clientSelect.insertAdjacentElement("afterend", proBtn);

proBtn.addEventListener("click", () => {
  proBtn.style.display = "inline-block";
  partBtn.style.display = "none";
  clientSelect.value = "PRO";
});
partBtn.addEventListener("click", () => {
  partBtn.style.display = "inline-block";
  proBtn.style.display = "none";
  clientSelect.value = "PART";
});

function resetProPartButtons() {
  proBtn.style.display = "inline-block";
  partBtn.style.display = "inline-block";
}

// ✅ Réinitialisation boutons quand on clique sur "Modifier"
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("btn-modifier")) {
    resetProPartButtons();
    // ICI : tu peux aussi pré-remplir le formulaire avec les données de la réservation sélectionnée
  }
});

// Chargement initial
loadReservations();
</script>

</body>
</html>




